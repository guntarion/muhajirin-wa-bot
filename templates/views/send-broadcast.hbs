<div>
    <h1>Kirim Pesan Broadcast</h1>
</div>

<div class="container">
    <form id="broadcastForm">
        <div class="form-group">
            <label for="broadcastNama">Nama Sesi Broadcast:</label>
            <input type="text" id="broadcastNama" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="groupSelect">Pilih Group:</label>
            <select id="groupSelect" class="form-control" required>
                <option value="">Select a Group</option>
                {{#each groups}}
                <option value="{{groupId}}">{{groupName}}</option>
                {{/each}}
            </select>
        </div>
        <div class="form-group">
            <label for="messageText">Pesan:</label>
            <textarea id="messageText" class="form-control" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Kirim Pesan</button>
    </form>
    <div id="progressContainer" style="display:none;">
        <h3>Progress</h3>
        <p id="progressText">Progress = 0 out of 0 (0%)</p>
        <p id="currentMessage">Sending message to </p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('broadcastForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const broadcastNama = document.getElementById('broadcastNama').value;
            const groupId = document.getElementById('groupSelect').value;
            const messageText = document.getElementById('messageText').value;

            if (!groupId) {
                alert('Please select a group');
                return;
            }

            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'block';

            try {
                const response = await fetch('/api/send-group-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ groupId, message: messageText, broadcastNama })
                });
                const result = await response.json();
                console.log('Response:', result);

                // Start polling for progress
                const pollInterval = setInterval(async () => {
                    const progressResponse = await fetch(`/api/check-progress/${broadcastNama}`);
                    const progressResult = await progressResponse.json();
                    if (progressResult.success) {
                        const { current, total, contactStoredName, contactNumber } = progressResult.progress;
                        updateProgress(current, total, contactStoredName, contactNumber);
                        if (current === total) {
                            clearInterval(pollInterval);
                        }
                    }
                }, 5000); // Poll every 5 seconds
            } catch (error) {
                console.error('Error sending group message:', error);
            }
        });
    });

    function updateProgress(current, total, contactStoredName, contactNumber) {
        const percentage = Math.round((current / total) * 100);
        document.getElementById('progressText').textContent = `Progress = ${current} out of ${total} (${percentage}%)`;
        document.getElementById('currentMessage').textContent = `Sending message to ${contactStoredName} (${contactNumber})`;
    }
</script>